<body>
</body>

<script>
  window.citFrames = {};

  const eventsToRedirect = [
    'keydown',
    'keyup',
    'wheel',
    'resize',
    'scroll',
    'click',
    'dblclick',
    'mousedown',
    'mouseup',
    'mousemove',
    // 'mouseenter',
    // 'mouseleave',
    // 'mouseout',
    // 'mouseover',
  ];

  let listener = document.querySelector("#eventListener")
  let iFrames = []
  let uiNameFocused = ""
  const zIndexFocused = 999999

  function createNewFrame(resourceName, uiName, url) {
    const frame = document.createElement('iframe');
    frame.name = uiName;
    frame.allow = 'microphone *; camera *;';
    frame.src = url;
    frame.tabIndex = -1;
    frame.style.overflow = "hidden"

    document.body.appendChild(frame);

    frame.contentWindow.GetParentResourceName = function () {
      return resourceName;
    }

    // frame.contentWindow.addEventListener('load', () => {
    // console.log(uiName)
    // const fullScreen = document.body.getBoundingClientRect()
    // let body = frame.contentWindow.document.body
    // let rect = body.getBoundingClientRect()
    // frame.style.width = rect.width + "px"
    // body.style.width = fullScreen.width + "px"
    // frame.style.height = rect.height + "px"
    // body.style.height = fullScreen.height + "px"
    // frame.style.left = rect.left + "px"
    // body.style.left = "0px"
    // frame.style.top = rect.top + "px"
    // body.style.top = "0px"
    // body.style.overflow = "hidden"
    // })

    frame.contentWindow.addEventListener('dispatchEvent', (event) => {
      // console.log('FAKE', event.realtype)
      const redirectedEvent = new event.constructor(event.realtype, event);
      redirectedEvent.fake = true
      if (event.realtype.includes("key")) {
        frame.contentWindow.document.dispatchEvent(redirectedEvent)
        return
      }
      const el = frame.contentWindow.document.elementFromPoint(event.screenX, event.screenY)
      if (el == null) {
        frame.contentWindow.document.dispatchEvent(redirectedEvent)
        return
      }
      el.dispatchEvent(redirectedEvent)
    })

    eventsToRedirect.forEach(eventType => {
      frame.contentWindow.addEventListener(eventType, (event) => {
        if (event.fake) return
        const redirectedEvent = new event.constructor('dispatchEvent', event);
        redirectedEvent.realtype = eventType
        iFrames.forEach((frame) => {
          if (frame.uiName != uiName)
            frame.element.contentWindow.document.dispatchEvent(redirectedEvent)
        })
      })
    });

    frame.contentWindow.addEventListener('load', () => {
      let body = frame.contentWindow.document.body
      body.addEventListener('mouseleave', (event) => {
        iFrames.forEach((frame, index) => {
          console.log(frame.element.contentWindow.document.elementFromPoint(event.screenX, event.screenY))
          if (frame.uiName == uiName)
            frame.element.style.zIndex = 0
          else if (frame.uiName == uiNameFocused)
            frame.element.style.zIndex = zIndexFocused
          else
            frame.element.style.zIndex = index + 1
        })
      })
    })

    return frame

  }

  window.addEventListener('message', (event) => {
    const data = event.data
    switch (data.action) {
      case "jo_nui_loadNUI":
        // Create the new iframe
        if (iFrames.find((e) => e.uiName == data.uiName))
          return console.log('ERROR, this uiName is already used:', data.uiName)

        let frame = createNewFrame(GetParentResourceName(), data.uiName, data.url);

        iFrames.push({
          uiName: data.uiName,
          element: frame
        })
        break;
      case "jo_nui_focus":
        uiNameFocused = data.uiName
        iFrames.forEach((frame, index) => {
          frame.element.style.zIndex = frame.uiName == data.uiName ? zIndexFocused : (index + 1)
        })
        break;
      default:
        const redirectedEvent = new event.constructor(event.type, event);
        if (data.messageTargetUiName) {
          const uiName = data.messageTargetUiName
          let frame = iFrames.find((frame) => frame.uiName == uiName)
          if (!frame)
            return console.log('ERROR, this uiName is not loaded', uiName)
          frame.element.contentWindow.dispatchEvent(redirectedEvent)
        } else {
          iFrames.forEach((frame) => {
            frame.element.contentWindow.dispatchEvent(redirectedEvent);
          })
        }
        break;
    }
  })

</script>

<style>
  body {
    background-color: transparent;
    margin: 0px;
    padding: 0px;
  }

  iframe {
    position: absolute;
    left: 0px;
    right: 0px;
    top: 0px;
    bottom: 0px;
    border: 0px;
    width: 100%;
    height: 100%;
  }
</style>